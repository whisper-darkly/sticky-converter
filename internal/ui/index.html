<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sticky Refinery · API Console</title>
  <style>
    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --surface2: #1c2128;
      --border:   #30363d;
      --text:     #c9d1d9;
      --muted:    #8b949e;
      --accent:   #388bfd;
      --get-bg:   rgba(35,134,54,0.15);
      --get-fg:   #3fb950;
      --post-bg:  rgba(56,139,253,0.15);
      --post-fg:  #79c0ff;
      --patch-bg: rgba(210,153,34,0.15);
      --patch-fg: #e3b341;
      --ws-bg:    rgba(188,140,255,0.15);
      --ws-fg:    #bc8cff;
      --ok-fg:    #3fb950;
      --err-fg:   #f85149;
      --font-mono: ui-monospace, 'Cascadia Code', 'Fira Code', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 14px;
    }

    /* ── Header ── */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .health-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background .3s;
    }
    .health-dot.ok  { background: var(--ok-fg); box-shadow: 0 0 6px var(--ok-fg); }
    .health-dot.err { background: var(--err-fg); }

    header h1 { font-size: 16px; font-weight: 600; color: #e6edf3; white-space: nowrap; }

    .header-tag {
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--ws-bg);
      color: var(--ws-fg);
      padding: 2px 7px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .header-sep { flex: 1; }

    #base-url-input {
      width: 300px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 12px;
      outline: none;
    }
    #base-url-input:focus { border-color: var(--accent); }

    /* ── Main grid ── */
    main {
      display: grid;
      grid-template-columns: 1fr 420px;
      flex: 1;
      overflow: hidden;
    }

    /* ── API Explorer ── */
    #api-explorer {
      overflow-y: auto;
      padding: 14px 16px 30px;
      border-right: 1px solid var(--border);
    }

    .group-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 18px 0 7px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .group-label:first-child { padding-top: 4px; }

    .ep-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 7px;
    }

    .ep-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      cursor: pointer;
      user-select: none;
      background: var(--surface);
      transition: background .12s;
    }
    .ep-header:hover { background: var(--surface2); }

    .method {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
      min-width: 52px;
      text-align: center;
      flex-shrink: 0;
    }
    .m-GET   { background: var(--get-bg);   color: var(--get-fg); }
    .m-POST  { background: var(--post-bg);  color: var(--post-fg); }
    .m-PATCH { background: var(--patch-bg); color: var(--patch-fg); }

    .ep-path {
      font-family: var(--font-mono);
      font-size: 13px;
      color: #e6edf3;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ep-desc {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }

    .chevron {
      color: var(--muted);
      font-size: 10px;
      flex-shrink: 0;
      transition: transform .2s;
    }
    .ep-card.open .chevron { transform: rotate(90deg); }

    .ep-body {
      display: none;
      padding: 14px;
      background: #0d1117;
      border-top: 1px solid var(--border);
    }
    .ep-card.open .ep-body { display: block; }

    .field-section { margin-bottom: 12px; }

    .field-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }
    .field-row label {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text);
      min-width: 90px;
      flex-shrink: 0;
    }

    input[type=text], textarea, select {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 9px;
      border-radius: 5px;
      font-family: var(--font-mono);
      font-size: 12px;
      outline: none;
      transition: border-color .15s;
    }
    input[type=text]:focus, textarea:focus { border-color: var(--accent); }

    textarea { resize: vertical; min-height: 72px; width: 100%; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: filter .15s;
      white-space: nowrap;
    }
    .btn:hover:not(:disabled) { filter: brightness(1.1); }
    .btn:disabled { opacity: .4; cursor: default; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-green   { background: #1a7f37; color: #fff; }
    .btn-red     { background: #b91c1c; color: #fff; }
    .btn-neutral { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }

    /* Response area */
    .resp-area {
      display: none;
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .resp-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .resp-status {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
    }
    .s2xx { background: var(--get-bg);  color: var(--get-fg); }
    .s4xx { background: rgba(248,81,73,.15); color: #f85149; }
    .s5xx { background: rgba(248,81,73,.15); color: #f85149; }

    .resp-time { margin-left: auto; color: var(--muted); font-size: 11px; }

    .resp-body {
      padding: 10px;
      font-family: var(--font-mono);
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 280px;
      overflow-y: auto;
      line-height: 1.5;
    }

    /* JSON colours */
    .jk { color: #79c0ff; }   /* key */
    .js { color: #a5d6ff; }   /* string value */
    .jn { color: #f2cc60; }   /* number */
    .jb { color: #ff7b72; }   /* bool */
    .jz { color: #ff7b72; }   /* null */

    /* ── WebSocket Monitor ── */
    #ws-panel {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      overflow: hidden;
    }

    .ws-top {
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .ws-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .ws-title-row h2 { font-size: 14px; font-weight: 600; }
    .ws-badge {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
      background: var(--ws-bg);
      color: var(--ws-fg);
    }

    .ws-url-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    #ws-url-input { flex: 1; }

    .ws-send-row {
      display: flex;
      gap: 6px;
    }
    #ws-send-input { flex: 1; font-size: 12px; }

    .ws-status-bar {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .ws-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background .3s;
    }
    .ws-dot.connected   { background: var(--ok-fg); box-shadow: 0 0 5px var(--ok-fg); }
    .ws-dot.connecting  { background: var(--patch-fg); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: .3; } }

    #ws-log {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px;
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .log-row {
      display: flex;
      gap: 7px;
      padding: 3px 5px;
      border-radius: 4px;
      line-height: 1.5;
    }
    .log-row:hover { background: rgba(255,255,255,.03); }

    .log-ts   { color: var(--muted); flex-shrink: 0; min-width: 88px; }
    .log-kind { font-weight: 700; flex-shrink: 0; min-width: 34px; }
    .k-recv { color: var(--post-fg); }
    .k-sent { color: var(--get-fg); }
    .k-sys  { color: var(--muted); }
    .k-err  { color: var(--err-fg); }

    .log-msg { color: var(--text); white-space: pre-wrap; word-break: break-all; }

    .ws-foot {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 14px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    #ws-count { font-size: 11px; color: var(--muted); }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  </style>
</head>
<body>

<header>
  <div class="health-dot" id="healthDot" title="Service health"></div>
  <h1>Sticky Refinery</h1>
  <span class="header-tag">API Console</span>
  <div class="header-sep"></div>
  <label style="font-size:12px;color:var(--muted);margin-right:6px;">Base URL</label>
  <input type="text" id="base-url-input" value="" placeholder="http://localhost:8080" oninput="onBaseUrlChange()">
</header>

<main>
  <section id="api-explorer"></section>

  <section id="ws-panel">
    <div class="ws-top">
      <div class="ws-title-row">
        <h2>WebSocket Monitor</h2>
        <span class="ws-badge">GET /ws</span>
      </div>
      <div class="ws-url-row">
        <input type="text" id="ws-url-input" placeholder="ws://localhost:8080/ws">
        <button class="btn btn-green"    id="wsConnBtn"  onclick="wsConnect()">Connect</button>
        <button class="btn btn-red"      id="wsDiscBtn"  onclick="wsDisconnect()" disabled>Disconnect</button>
      </div>
      <div class="ws-send-row">
        <input type="text" id="ws-send-input" placeholder='Send JSON message (optional)…' onkeydown="if(event.key==='Enter')wsSend()">
        <button class="btn btn-neutral" onclick="wsSend()">Send</button>
      </div>
    </div>

    <div class="ws-status-bar">
      <div class="ws-dot" id="wsDot"></div>
      <span id="wsStatusText">Disconnected</span>
    </div>

    <div id="ws-log"></div>

    <div class="ws-foot">
      <span id="ws-count">0 messages</span>
      <button class="btn btn-neutral" onclick="clearLog()" style="font-size:12px;padding:4px 10px;">Clear</button>
    </div>
  </section>
</main>

<script>
// ────────────────────────────────────────────
//  Endpoint definitions
// ────────────────────────────────────────────
const ENDPOINTS = [
  // Health
  {
    group: 'Health',
    method: 'GET', path: '/health',
    desc: 'Check service health',
    pathParams: [], queryParams: [], body: null,
  },

  // Configuration
  {
    group: 'Configuration',
    method: 'GET', path: '/config',
    desc: 'Reload and return full configuration from disk',
    pathParams: [], queryParams: [], body: null,
  },

  // Pool
  {
    group: 'Pool',
    method: 'GET', path: '/pool',
    desc: 'Worker pool status: size, active workers',
    pathParams: [], queryParams: [], body: null,
  },
  {
    group: 'Pool',
    method: 'PATCH', path: '/pool',
    desc: 'Resize pool or change shrink settings',
    pathParams: [], queryParams: [],
    body: { size: 4, shrink_grace: '1m', shrink_kill_order: 'oldest' },
  },

  // Pipelines
  {
    group: 'Pipelines',
    method: 'GET', path: '/pipelines',
    desc: 'List all pipelines with aggregate stats',
    pathParams: [], queryParams: [], body: null,
  },
  {
    group: 'Pipelines',
    method: 'GET', path: '/pipelines/{name}',
    desc: 'Get pipeline config, DB extra overrides, and stats',
    pathParams: [{ name: 'name', placeholder: 'pipeline-name' }],
    queryParams: [], body: null,
  },
  {
    group: 'Pipelines',
    method: 'PATCH', path: '/pipelines/{name}',
    desc: 'Persist extra key/value overrides for a pipeline',
    pathParams: [{ name: 'name', placeholder: 'pipeline-name' }],
    queryParams: [],
    body: { key: 'value' },
  },

  // Tasks
  {
    group: 'Tasks',
    method: 'GET', path: '/tasks',
    desc: 'List tasks — filterable by pipeline, status, limit/offset',
    pathParams: [],
    queryParams: [
      { name: 'pipeline', placeholder: 'pipeline-name (optional)' },
      { name: 'status',   placeholder: 'queued | in_flight | completed | errored | paused' },
      { name: 'limit',    placeholder: '20' },
      { name: 'offset',   placeholder: '0' },
    ],
    body: null,
  },
  {
    group: 'Tasks',
    method: 'GET', path: '/tasks/{id}',
    desc: 'Get a single task by its base64-encoded file path',
    pathParams: [{ name: 'id', placeholder: 'base64url-encoded path' }],
    queryParams: [], body: null,
  },
  {
    group: 'Tasks',
    method: 'POST', path: '/tasks/{id}/stop',
    desc: 'Stop a currently running task',
    pathParams: [{ name: 'id', placeholder: 'base64url-encoded path' }],
    queryParams: [], body: null,
  },
  {
    group: 'Tasks',
    method: 'POST', path: '/tasks/{id}/pause',
    desc: 'Pause a task (stops if running, marks paused in DB)',
    pathParams: [{ name: 'id', placeholder: 'base64url-encoded path' }],
    queryParams: [], body: null,
  },
  {
    group: 'Tasks',
    method: 'POST', path: '/tasks/{id}/resume',
    desc: 'Resume a paused or errored task',
    pathParams: [{ name: 'id', placeholder: 'base64url-encoded path' }],
    queryParams: [], body: null,
  },
];

// ────────────────────────────────────────────
//  URL helpers
// ────────────────────────────────────────────
function getBase() {
  return (document.getElementById('base-url-input').value || '').replace(/\/$/, '');
}

function onBaseUrlChange() {
  const base = getBase();
  const wsBase = base.replace(/^https?/, m => m === 'https' ? 'wss' : 'ws');
  document.getElementById('ws-url-input').value = wsBase + '/ws';
}

// Init base URL from current page origin
(function initUrls() {
  const base = window.location.origin;
  document.getElementById('base-url-input').value = base;
  const wsProto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  document.getElementById('ws-url-input').value = `${wsProto}//${window.location.host}/ws`;
})();

// ────────────────────────────────────────────
//  Render endpoints
// ────────────────────────────────────────────
function render() {
  const root = document.getElementById('api-explorer');
  let lastGroup = '';

  ENDPOINTS.forEach((ep, idx) => {
    if (ep.group !== lastGroup) {
      lastGroup = ep.group;
      const g = document.createElement('div');
      g.className = 'group-label';
      g.textContent = ep.group;
      root.appendChild(g);
    }
    root.appendChild(buildCard(ep, idx));
  });
}

function buildCard(ep, idx) {
  const card = document.createElement('div');
  card.className = 'ep-card';

  // Header row
  const hdr = document.createElement('div');
  hdr.className = 'ep-header';
  hdr.innerHTML = `
    <span class="method m-${ep.method}">${ep.method}</span>
    <span class="ep-path">${ep.path}</span>
    <span class="ep-desc">${ep.desc}</span>
    <span class="chevron">▶</span>
  `;
  hdr.onclick = () => card.classList.toggle('open');

  // Body
  const body = document.createElement('div');
  body.className = 'ep-body';
  body.innerHTML = buildForm(ep, idx);

  card.appendChild(hdr);
  card.appendChild(body);
  return card;
}

function buildForm(ep, idx) {
  let h = '';

  // Path params
  if (ep.pathParams.length) {
    h += `<div class="field-section"><div class="field-title">Path Parameters</div>`;
    ep.pathParams.forEach(p => {
      h += `<div class="field-row">
        <label>{${esc(p.name)}}</label>
        <input type="text" id="pp-${idx}-${p.name}" placeholder="${esc(p.placeholder)}">
      </div>`;
    });
    h += `</div>`;
  }

  // Query params
  if (ep.queryParams.length) {
    h += `<div class="field-section"><div class="field-title">Query Parameters</div>`;
    ep.queryParams.forEach(q => {
      h += `<div class="field-row">
        <label>${esc(q.name)}</label>
        <input type="text" id="qp-${idx}-${q.name}" placeholder="${esc(q.placeholder)}">
      </div>`;
    });
    h += `</div>`;
  }

  // Body
  if (ep.body !== null) {
    h += `<div class="field-section">
      <div class="field-title">Request Body (JSON)</div>
      <textarea id="rb-${idx}">${esc(JSON.stringify(ep.body, null, 2))}</textarea>
    </div>`;
  }

  h += `<button class="btn btn-primary" onclick="execEndpoint(${idx})">▶ Execute</button>`;

  h += `<div class="resp-area" id="ra-${idx}">
    <div class="resp-bar">
      <span class="resp-status" id="rs-${idx}"></span>
      <span class="resp-time"   id="rt-${idx}"></span>
    </div>
    <div class="resp-body" id="rb-out-${idx}"></div>
  </div>`;

  return h;
}

// ────────────────────────────────────────────
//  Execute
// ────────────────────────────────────────────
async function execEndpoint(idx) {
  const ep = ENDPOINTS[idx];
  const base = getBase();

  // Resolve path params
  let url = ep.path;
  ep.pathParams.forEach(p => {
    const v = (document.getElementById(`pp-${idx}-${p.name}`) || {}).value || '';
    url = url.replace(`{${p.name}}`, encodeURIComponent(v));
  });

  // Query string
  if (ep.queryParams.length) {
    const parts = ep.queryParams
      .map(q => {
        const v = (document.getElementById(`qp-${idx}-${q.name}`) || {}).value || '';
        return v ? `${q.name}=${encodeURIComponent(v)}` : '';
      })
      .filter(Boolean);
    if (parts.length) url += '?' + parts.join('&');
  }

  const opts = { method: ep.method };
  if (ep.body !== null) {
    const raw = (document.getElementById(`rb-${idx}`) || {}).value || '{}';
    opts.headers = { 'Content-Type': 'application/json' };
    opts.body = raw;
  }

  const t0 = Date.now();
  const raEl  = document.getElementById(`ra-${idx}`);
  const rsEl  = document.getElementById(`rs-${idx}`);
  const rtEl  = document.getElementById(`rt-${idx}`);
  const rbOut = document.getElementById(`rb-out-${idx}`);

  try {
    const res  = await fetch(base + url, opts);
    const ms   = Date.now() - t0;
    const text = await res.text();

    raEl.style.display = 'block';
    rtEl.textContent   = ms + ' ms';

    const cls = res.status >= 500 ? 's5xx' : res.status >= 400 ? 's4xx' : 's2xx';
    rsEl.className = 'resp-status ' + cls;
    rsEl.textContent = res.status + ' ' + res.statusText;

    try {
      rbOut.innerHTML = colorJson(JSON.parse(text));
    } catch {
      rbOut.textContent = text;
    }
  } catch (err) {
    raEl.style.display = 'block';
    rsEl.className = 'resp-status s5xx';
    rsEl.textContent = 'Network Error';
    rtEl.textContent = '';
    rbOut.textContent = err.message;
  }
}

// ────────────────────────────────────────────
//  JSON syntax highlighting
// ────────────────────────────────────────────
function colorJson(obj) {
  const raw = JSON.stringify(obj, null, 2);
  return esc(raw).replace(
    /("(?:\\.|[^"\\])*"(?:\s*:)?|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
    m => {
      const orig = m.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
      if (/^"/.test(orig)) {
        if (/:$/.test(orig)) return `<span class="jk">${m}</span>`;
        return `<span class="js">${m}</span>`;
      }
      if (orig === 'true' || orig === 'false') return `<span class="jb">${m}</span>`;
      if (orig === 'null')  return `<span class="jz">${m}</span>`;
      return `<span class="jn">${m}</span>`;
    }
  );
}

function esc(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ────────────────────────────────────────────
//  WebSocket
// ────────────────────────────────────────────
let ws = null;
let msgCount = 0;

function wsConnect() {
  const url = document.getElementById('ws-url-input').value.trim();
  if (!url) return;

  setWsUi('connecting', 'Connecting…');
  document.getElementById('wsConnBtn').disabled = true;

  ws = new WebSocket(url);

  ws.onopen = () => {
    setWsUi('connected', 'Connected to ' + url);
    document.getElementById('wsDiscBtn').disabled = false;
    logWs('sys', 'Connected');
  };

  ws.onmessage = evt => {
    let text = evt.data;
    try {
      text = JSON.stringify(JSON.parse(evt.data), null, 2);
    } catch {}
    logWs('recv', text);
  };

  ws.onerror = () => logWs('err', 'WebSocket error');

  ws.onclose = evt => {
    setWsUi('', `Disconnected (code ${evt.code})`);
    document.getElementById('wsConnBtn').disabled = false;
    document.getElementById('wsDiscBtn').disabled = true;
    logWs('sys', `Closed — code ${evt.code}`);
    ws = null;
  };
}

function wsDisconnect() {
  if (ws) ws.close();
}

function wsSend() {
  const input = document.getElementById('ws-send-input');
  const msg = input.value.trim();
  if (!msg || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(msg);
  logWs('sent', msg);
  input.value = '';
}

function setWsUi(state, text) {
  const dot = document.getElementById('wsDot');
  dot.className = 'ws-dot' + (state ? ' ' + state : '');
  document.getElementById('wsStatusText').textContent = text;
}

function logWs(kind, msg) {
  const log = document.getElementById('ws-log');
  const row = document.createElement('div');
  row.className = 'log-row';

  const now = new Date();
  const ts  = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}.${pad3(now.getMilliseconds())}`;

  row.innerHTML = `
    <span class="log-ts">${ts}</span>
    <span class="log-kind k-${kind}">${kind.toUpperCase()}</span>
    <span class="log-msg">${esc(msg)}</span>
  `;

  log.appendChild(row);
  log.scrollTop = log.scrollHeight;

  msgCount++;
  document.getElementById('ws-count').textContent =
    msgCount + ' message' + (msgCount !== 1 ? 's' : '');
}

function clearLog() {
  document.getElementById('ws-log').innerHTML = '';
  msgCount = 0;
  document.getElementById('ws-count').textContent = '0 messages';
}

function pad2(n) { return String(n).padStart(2, '0'); }
function pad3(n) { return String(n).padStart(3, '0'); }

// ────────────────────────────────────────────
//  Health polling
// ────────────────────────────────────────────
async function checkHealth() {
  const dot = document.getElementById('healthDot');
  try {
    const r = await fetch(getBase() + '/health');
    dot.className = 'health-dot ' + (r.ok ? 'ok' : 'err');
    dot.title = r.ok ? 'Service healthy' : 'Service returned ' + r.status;
  } catch {
    dot.className = 'health-dot err';
    dot.title = 'Service unreachable';
  }
}

// ────────────────────────────────────────────
//  Boot
// ────────────────────────────────────────────
render();
checkHealth();
setInterval(checkHealth, 10000);
</script>
</body>
</html>
