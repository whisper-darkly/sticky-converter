# sticky-refinery — sticky-overseer config format
name: "sticky-refinery"
listen: ":8080"
db: /data/sticky-refinery.db
trusted_cidrs: []

# Global pool defaults (overridden per-action)
task_pool:
  limit: 4
  queue:
    enabled: true
    size: 100

retry: {}

actions:
  ts-to-mp4:
    type: converter
    task_pool:
      limit: 4
    dedupe_key: ["file"]  # prevents double-queuing the same file path
    config:
      scan_interval: "30s"
      paths:
        - "/recordings/**/*.ts"
      direction: "oldest"
      min_age: "5m"
      max_age: null
      delete_on_success: true
      db_path: "/data/sticky-refinery.db"
      target:
        regex: "^(?P<base>.+)\\.ts$"
        format: "{{.File.Dir}}/{{.File.Basename}}.mp4"
      # Software encoding (CPU) — works everywhere:
      command: "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v libx264 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
      #
      # NVIDIA GPU encoding (NVENC) — requires NVIDIA GPU + Container Toolkit on the host,
      # and compose-bb-nvidia.yaml (or equivalent --gpus all + NVIDIA_DRIVER_CAPABILITIES=compute,video,utility).
      # Drop-in replacements for the command above:
      #
      #   H.264:  "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v h264_nvenc -preset p4 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
      #   H.265:  "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v hevc_nvenc -preset p4 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
      #   AV1:    "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v av1_nvenc  -preset p4 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
      #           (AV1 requires RTX 40xx / Ada Lovelace or newer)
      #
      # The same Docker image supports both CPU and NVENC — only the command changes.
